---
description: IndexAll 后端开发规范。编辑 server 包时自动加载，提供数据库和 API 开发的关键约定。
globs: packages/server/**
alwaysApply: false
---

# IndexAll 后端开发规范

## 开始前必读

- 涉及数据库操作 → 先读 `MODEL.md`（表结构、索引、关键查询、FTS5 触发器）
- 涉及 API 接口 → 先读 `API_DESIGN.md`（输入输出定义、业务规则）

## 数据库约定

- ORM: Drizzle（SQLite 方言），schema 定义在 server 包内
- 标签 DAG 关系: 邻接表存储，通过递归 CTE 查询子树
- 全文搜索: SQLite FTS5，通过 AFTER INSERT/UPDATE/DELETE 触发器自动同步
- **DAG 操作前必须做环检测**（递归 CTE 查祖先链）
- **`source + externalId`** 是资源复合唯一标识（手动添加的 externalId 为 NULL）
- 标签名和别名**全局唯一**（跨标签名和别名表去重）
- 时间字段存储为 ISO 8601 TEXT

## API 约定

- tRPC on Hono，按领域划分 router: `tag.*`, `resource.*`
- 标签的增删通过 `resource.addTag` / `resource.removeTag`，**不经过** `resource.update`
- 资源的 `source` / `externalId` 创建后**不可变**
- 删除标签时：级联删除别名、DAG 关系、资源关联；**不删除**子标签和关联资源本身
- 删除资源时：级联删除资源-标签关联，FTS5 由触发器自动清理

## 变更后维护

- 新增/修改表结构或索引 → 更新 `MODEL.md`
- 新增/修改 tRPC procedure → 更新 `API_DESIGN.md`（输入输出 + 业务规则）
